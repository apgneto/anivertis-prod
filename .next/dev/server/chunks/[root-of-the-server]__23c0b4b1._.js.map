{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/apgne/anivertis-prod/src/app/api/dados/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport sqlite3 from 'sqlite3';\r\nimport { open } from 'sqlite';\r\nimport path from 'path';\r\n\r\nexport const dynamic = 'force-dynamic';\r\nexport const runtime = 'nodejs';\r\n\r\nexport async function GET(request: Request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const limit = parseInt(searchParams.get('limit') || '50');\r\n    const theme = searchParams.get('theme');\r\n    const source = searchParams.get('source');\r\n\r\n    // Caminho absoluto para o banco de dados\r\n    const dbPath = path.join(process.cwd(), 'data', 'anivertis.db');\r\n    \r\n    // Verificar se o banco existe\r\n    const fs = require('fs');\r\n    if (!fs.existsSync(dbPath)) {\r\n      return NextResponse.json({\r\n        success: false,\r\n        error: 'Banco de dados ainda não foi criado. Execute o scraper primeiro.',\r\n        dados: [],\r\n        health: []\r\n      });\r\n    }\r\n\r\n    // Conectar ao banco SQLite\r\n    const db = await open({\r\n      filename: dbPath,\r\n      driver: sqlite3.Database\r\n    });\r\n\r\n    // Buscar últimas coletas\r\n    let query = `\r\n      SELECT \r\n        id, source_name, title, content, url, \r\n        published_at, collected_at, score, layer, theme\r\n      FROM coletas \r\n      WHERE 1=1\r\n    `;\r\n    const params: any[] = [];\r\n\r\n    if (theme) {\r\n      query += ` AND theme = ?`;\r\n      params.push(theme);\r\n    }\r\n\r\n    if (source) {\r\n      query += ` AND source_name LIKE ?`;\r\n      params.push(`%${source}%`);\r\n    }\r\n\r\n    query += ` ORDER BY collected_at DESC LIMIT ?`;\r\n    params.push(limit);\r\n\r\n    const dados = await db.all(query, params);\r\n\r\n    // Buscar health das fontes\r\n    const health = await db.all(`\r\n      SELECT * FROM source_health \r\n      ORDER BY last_check DESC \r\n      LIMIT 20\r\n    `);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      timestamp: new Date().toISOString(),\r\n      count: dados.length,\r\n      dados,\r\n      health\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('Erro na API:', error);\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: error.message,\r\n      dados: [],\r\n      health: []\r\n    }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;;AAAA;;;;;;;;;;;AAGA;;;;;AAEO,MAAM,UAAU;AAChB,MAAM,UAAU;AAEhB,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,QAAQ,SAAS,aAAa,GAAG,CAAC,YAAY;QACpD,MAAM,QAAQ,aAAa,GAAG,CAAC;QAC/B,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,yCAAyC;QACzC,MAAM,SAAS,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;QAEhD,8BAA8B;QAC9B,MAAM;QACN,IAAI,CAAC,GAAG,UAAU,CAAC,SAAS;YAC1B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;gBACP,OAAO,EAAE;gBACT,QAAQ,EAAE;YACZ;QACF;QAEA,2BAA2B;QAC3B,MAAM,KAAK,MAAM,KAAK;YACpB,UAAU;YACV,QAAQ,QAAQ,QAAQ;QAC1B;QAEA,yBAAyB;QACzB,IAAI,QAAQ,CAAC;;;;;;IAMb,CAAC;QACD,MAAM,SAAgB,EAAE;QAExB,IAAI,OAAO;YACT,SAAS,CAAC,cAAc,CAAC;YACzB,OAAO,IAAI,CAAC;QACd;QAEA,IAAI,QAAQ;YACV,SAAS,CAAC,uBAAuB,CAAC;YAClC,OAAO,IAAI,CAAC,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC;QAC3B;QAEA,SAAS,CAAC,mCAAmC,CAAC;QAC9C,OAAO,IAAI,CAAC;QAEZ,MAAM,QAAQ,MAAM,GAAG,GAAG,CAAC,OAAO;QAElC,2BAA2B;QAC3B,MAAM,SAAS,MAAM,GAAG,GAAG,CAAC,CAAC;;;;IAI7B,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,WAAW,IAAI,OAAO,WAAW;YACjC,OAAO,MAAM,MAAM;YACnB;YACA;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,MAAM,OAAO;YACpB,OAAO,EAAE;YACT,QAAQ,EAAE;QACZ,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}